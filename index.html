<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>iPrincesses - Home</title>
  <style>
  .brand-title {
  font-size: 4rem;         /* Extra large */
  font-weight: 900;        /* Extra bold */
  color: var(--brand);
  text-align: center;      /* Center the title */
  margin-bottom: 1.5rem;
  text-shadow: 2px 2px 5px rgba(0,0,0,0.2); /* Subtle shadow */
}
.brand-title img {
  vertical-align: middle;
  height: 50px;            /* Slightly bigger princess icon */
}
  </style>
</head>
<body>
  <h1 class="brand-title">
  iPrincesses 
  <img src="princess.png" alt="Princess" style="height:50px; vertical-align:middle; margin-left:8px;">
  <span class="pill">Beta</span>
</h1>

  <!-- Payment Profile -->
  <h2>Payment Profile</h2>
  <div class="field">
    <input type="tel" id="phone-number" placeholder="Your phone number (e.g., 2567XXXXXXXX)" />
    <div class="help">Used for Mobile Money payments via Flutterwave (UGX).</div>
  </div>
  <div class="inline">
    <input type="number" id="amount-ugx" placeholder="Amount (UGX)" min="100" step="100" value="5000" />
    <button id="pay-btn" type="button">Pay via Mobile Money (UG)</button>
  </div>

  <!-- Search -->
  <h2>Search</h2>
  <div class="search-container">
    <input type="text" id="search-input" placeholder="Search posts or users (prefix match)â€¦" />
    <button id="search-btn" title="Search">
      <img src="" alt="Search" />
    </button>
  </div>
  <div id="search-results"></div>

  <!-- Posts -->
<h2>Posts</h2>
<div id="posts-container"></div>
<form id="post-form" class="row" enctype="multipart/form-data">
  <div class="col">
    <input type="text" id="post-content" placeholder="Create a post..." />
    <input type="file" id="post-file" accept="image/*,video/*,.pdf,.doc,.docx" />
    <div class="help">You can attach an image, video, or document.</div>
  </div>
  <div class="col" style="flex:0 0 auto;">
    <button type="submit">Post</button>
  </div>
</form>

  <!-- Chat -->
  <h2>Chat</h2>
  <div id="chat-container"></div>
  <form id="chat-form" class="row">
    <div class="col">
      <input type="text" id="chat-message" placeholder="Type a message..." required />
    </div>
    <div class="col" style="flex:0 0 auto;">
      <button type="submit">Send</button>
    </div>
  </form>

  <!-- Location -->
  <h2>Share Your Location</h2>
  <div class="inline">
    <button id="share-location-btn" type="button">Share My Location</button>
    <span class="muted">Weâ€™ll drop a pin on the map and store coordinates with your account.</span>
  </div>
  <div id="map" style="height:300px; width:100%;"></div>

  <!-- SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=REPLACE_ME_GOOGLE_MAPS_API_KEY"></script>
  <script src="https://checkout.flutterwave.com/v3.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBE7nyRgJU3-VEvnx_MgUJFcN7Qz04yT0g",
      authDomain: "iprincesses-f4f94.firebaseapp.com",
      projectId: "iprincesses-f4f94",
      storageBucket: "iprincesses-f4f94.appspot.com",
      messagingSenderId: "867887611060",
      appId: "1:867887611060:web:f5c15533019c98d4c26be1",
      measurementId: "G-7C9VZKX8MW"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const $ = id => document.getElementById(id);
    const toast = msg => alert(msg);

    // ====== POSTS ======
    const postsContainer = $("posts-container");
  const storage = firebase.storage();

  $("post-form").addEventListener("submit", async e => {
    e.preventDefault();
    const content = $("post-content").value.trim();
    const file = $("post-file").files[0];
    let fileUrl = null, fileType = null;

    if (file) {
      const storageRef = storage.ref("uploads/" + Date.now() + "_" + file.name);
      await storageRef.put(file);
      fileUrl = await storageRef.getDownloadURL();
      fileType = file.type;
    }

    await db.collection("posts").add({
      content,
      contentLower: content.toLowerCase(),
      user: "Anonymous",
      fileUrl,
      fileType,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    $("post-content").value = "";
    $("post-file").value = "";
  });

  db.collection("posts").orderBy("timestamp", "desc").limit(100)
    .onSnapshot(snapshot => {
      postsContainer.innerHTML = "";
      snapshot.forEach(doc => {
        const post = doc.data();
        const div = document.createElement("div");
        div.className="post";
        const when = post.timestamp?.toDate?.() ? new Date(post.timestamp.toDate()).toLocaleString() : "just now";

        let media = "";
        if (post.fileUrl) {
          if (post.fileType.startsWith("image/")) {
            media = `<br><img src="${post.fileUrl}" style="max-width:100%;border-radius:6px;">`;
          } else if (post.fileType.startsWith("video/")) {
            media = `<br><video controls style="max-width:100%;border-radius:6px;"><source src="${post.fileUrl}" type="${post.fileType}"></video>`;
          } else {
            media = `<br><a href="${post.fileUrl}" target="_blank">ðŸ“„ Download document</a>`;
          }
        }

        div.innerHTML = `<strong>${post.user}</strong> <span class="muted">â€¢ ${when}</span><br/>${post.content || ""}${media}`;
        postsContainer.appendChild(div);
      });
    });

    // ====== CHAT ======
    const chatContainer = $("chat-container");
    $("chat-form").addEventListener("submit", async e => {
      e.preventDefault();
      const message = $("chat-message").value.trim();
      if (!message) return;
      await db.collection("chats").add({
        message,
        messageLower: message.toLowerCase(),
        user: "Anonymous",
        userLower: "anonymous",
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      $("chat-message").value = "";
    });
    db.collection("chats").orderBy("timestamp", "asc").limit(200)
      .onSnapshot(snapshot => {
        chatContainer.innerHTML = "";
        snapshot.forEach(doc => {
          const chat = doc.data();
          const div = document.createElement("div");
          div.innerHTML = `<strong>${chat.user}:</strong> ${chat.message}`;
          chatContainer.appendChild(div);
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });

    // ====== SEARCH ======
    const searchInput = $("search-input");
    const searchBtn = $("search-btn");
    const searchResults = $("search-results");
    async function performSearchCore() {
      const q = searchInput.value.trim().toLowerCase();
      searchResults.innerHTML = "";
      if (!q) return;
      const end = q + "\uf8ff";
      const postsSnap = await db.collection("posts").orderBy("contentLower").startAt(q).endAt(end).limit(20).get();
      if (!postsSnap.empty) searchResults.innerHTML += "<h3>Posts</h3>";
      postsSnap.forEach(doc => {
        const post = doc.data();
        searchResults.innerHTML += `<div><strong>Post:</strong> ${post.content} <span class="muted">â€” ${post.user}</span></div>`;
      });
      const usersSnap = await db.collection("chats").orderBy("userLower").startAt(q).endAt(end).limit(50).get();
      const users = new Set();
      usersSnap.forEach(d => users.add(d.data().user));
      if (users.size) searchResults.innerHTML += "<h3>Users</h3>";
      users.forEach(user => {
        searchResults.innerHTML += `<div><strong>User:</strong> ${user}</div>`;
      });
    }
    searchInput.addEventListener("input", performSearchCore);
    searchBtn.addEventListener("click", e => { e.preventDefault(); performSearchCore(); });

    // ====== LOCATION ======
    $("share-location-btn").addEventListener("click", () => {
      if (!navigator.geolocation) return toast("Geolocation not supported");
      navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const map = new google.maps.Map($("map"), { center: {lat, lng}, zoom: 15 });
        new google.maps.Marker({ position: {lat, lng}, map, title: "You are here!" });
        await db.collection("locations").add({
          user: "Anonymous",
          latitude: lat,
          longitude: lng,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }, err => toast(err.message || "Unable to get location"));
    });

    // ====== FLUTTERWAVE PAYMENTS ======
    const FLW_PUBLIC_KEY = "REPLACE_ME_FLUTTERWAVE_PUBLIC_KEY";
    $("pay-btn").addEventListener("click", () => {
      const amount = parseInt($("amount-ugx").value, 10);
      const phone = $("phone-number").value.trim();
      const email = "guest@ipr.com";
      const name = "Anonymous";
      if (!amount || amount < 100) return toast("Enter a valid amount (>= 100 UGX).");
      if (!/^\d{9,15}$/.test(phone)) return toast("Enter a valid phone number (digits only, e.g., 2567XXXXXXXX).");
      FlutterwaveCheckout({
        public_key: FLW_PUBLIC_KEY,
        tx_ref: "tx-" + Date.now(),
        amount: amount,
        currency: "UGX",
        payment_options: "mobilemoneyuganda",
        customer: { email, phonenumber: phone, name },
        callback: async data => {
          await db.collection("payments").add({
            status: data.status,
            tx_id: data.transaction_id || null,
            tx_ref: data.tx_ref,
            amount,
            currency: "UGX",
            customer: { email, phone, name },
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          toast("Payment " + (data.status || "processed"));
        }
      });
    });
  </script>
</body>
</html>